#include "uart.h"

#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>

/******** uart.c file of C2.5 : UART Driver Code ********/
/*** bytes offsets of UART registers from char *base ***/
#define UDR 0x00
#define UFR 0x18

UART uart[4];  // 4 UART structures

int uart_init()  // UART initialization function
{
  int i;
  UART* up;
  for (i = 0; i < 4; i++) {  // uart0 to uart2 are adjacent
    up = &uart[i];
    up->base = (char*)(0x101F1000 + i * 0x1000);
    up->n = i;
  }
  uart[3].base = (char*)(0x10009000);  // uart3 at 0x10009000
}

int ugetc(UART* up)  // input a char from UART pointed by up
{
  while (*(up->base + UFR) & RXFE);  // loop if UFR is RXFE
  return *(up->base + UDR);          // return a char in UDR
}

int uputc(UART* up, char c)  // output a char to UART pointed by up
{
  while (*(up->base + UFR) & TXFF);  // loop if UFR is TXFF
  *(up->base + UDR) = c;             // write char to data register
}

int ugets(UART* up, char* s)  // input a string of chars
{
  while ((*s = ugetc(up)) != '\r') {
    uputc(up, *s);
    s++;
  }
  *s = 0;
}

int uprints(UART* up, char* s)  // output a string of chars
{
  while (*s) uputc(up, *s++);
}

#define MAX_STRING_LEN 255
int uprintu(UART* up, uint32_t val) {
  char output[MAX_STRING_LEN];
  uprints(up, itoa(val, output, 10));
}

int uprintd(UART* up, int val) {
  char output[MAX_STRING_LEN];
  uprints(up, itoa(val, output, 10));
}

int uprintx(UART* up, uint32_t val) {
  char output[MAX_STRING_LEN];
  uprints(up, itoa(val, output, 16));
}

int uprintf(UART* up, char* fmt, ...) {
  char* cp = fmt;            // cp points to the fmt string
  int* ip = (int*)&fmt + 1;  // ip points to first item in stack
  while (*cp) {              // scan the format string
    if (*cp != '%') {        // spit out ordinary chars
      uputc(up, *cp);
      if (*cp == '\n')    // for each ‘\n’
        uputc(up, '\r');  // print a ‘\r’
      cp++;
      continue;
    }
    cp++;           // cp points at a conversion symbol
    switch (*cp) {  // print item by %FORMAT symbol
      case 'c':
        uputc(up, (char)*ip);
        break;
      case 's':
        uprints(up, (char*)*ip);
        break;
      case 'u':
        uprintu(up, (uint32_t)*ip);
        break;
      case 'd':
        uprintd(up, (int)*ip);
        break;
      case 'x':
        uprintx(up, (uint32_t)*ip);
        break;
    }
    cp++;
    ip++;  // advance pointers
  }
}